<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Verification - chris@chris.com</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 1000px;
      width: 100%;
      padding: 40px;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .status-box {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info { color: #3b82f6; }
    .warning { color: #f59e0b; }
    .header { font-weight: bold; color: #6366f1; margin-top: 15px; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .data-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }
    .data-section h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .data-item {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      border-left: 4px solid #3b82f6;
      font-size: 12px;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span>üîç</span>
      Data Verification for chris@chris.com
    </h1>
    <div class="subtitle">Check current authentication and database state</div>

    <div class="button-group">
      <button onclick="checkAuth()">üîê Check Auth</button>
      <button onclick="checkProjects()">üìÅ Check Projects</button>
      <button onclick="checkTasks()">üìã Check Tasks</button>
      <button onclick="checkAPI()">‚ö° Test API</button>
      <button onclick="forceSignIn()">üö™ Force Sign In</button>
      <button onclick="clearLog()" style="background: #ef4444;">Clear Log</button>
    </div>

    <div class="loader" id="loader"></div>

    <div id="status" class="status-box">
      <div class="log-entry info">Ready to verify data...</div>
    </div>

    <div class="data-grid" id="dataGrid" style="display: none;">
      <div class="data-section">
        <h3>üìã Current User</h3>
        <div id="userData"></div>
      </div>
      <div class="data-section">
        <h3>üìÅ Projects</h3>
        <div id="projectData"></div>
      </div>
      <div class="data-section">
        <h3>üìã Tasks</h3>
        <div id="taskData"></div>
      </div>
      <div class="data-section">
        <h3>‚öôÔ∏è System Info</h3>
        <div id="systemData"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD_l6R1M5qn0desmVlc2-WQB5YcOcvVzKg",
      authDomain: "boardly-95104.firebaseapp.com",
      projectId: "boardly-95104",
      storageBucket: "boardly-95104.appspot.com",
      messagingSenderId: "55025563584",
      appId: "1:55025563584:web:c8e14cec187f006b87bd48"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let logEntries = [];
    let currentData = {};

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      logEntries.push({ message: logEntry, type });
      updateStatusBox();
    }

    function updateStatusBox() {
      const statusBox = document.getElementById('status');
      statusBox.innerHTML = logEntries.map(entry => 
        `<div class="log-entry ${entry.type}">${entry.message}</div>`
      ).join('');
      statusBox.scrollTop = statusBox.scrollHeight;
    }

    function clearLog() {
      logEntries = [];
      log('Log cleared. Ready to verify data...', 'info');
      document.getElementById('dataGrid').style.display = 'none';
    }

    function updateDataGrid() {
      const userData = document.getElementById('userData');
      const projectData = document.getElementById('projectData');
      const taskData = document.getElementById('taskData');
      const systemData = document.getElementById('systemData');

      userData.innerHTML = currentData.user ? 
        `<div class="data-item">Email: ${currentData.user.email}<br>UID: ${currentData.user.uid}<br>Name: ${currentData.user.displayName || 'N/A'}</div>` : 
        '<div class="data-item">No user data</div>';

      projectData.innerHTML = currentData.projects ? 
        currentData.projects.map(p => `<div class="data-item">üìÅ ${p.name} (ID: ${p.id})<br>Owner: ${p.owner || p.userId}</div>`).join('') : 
        '<div class="data-item">No project data</div>';

      taskData.innerHTML = currentData.tasks ? 
        `<div class="data-item">Total Tasks: ${currentData.tasks.length}<br>${currentData.tasks.slice(0, 5).map(t => `üìã ${t.title || 'Untitled'}`).join('<br>')}${currentData.tasks.length > 5 ? '<br>...' : ''}</div>` : 
        '<div class="data-item">No task data</div>';

      systemData.innerHTML = `
        <div class="data-item">
          API URL: ${currentData.apiUrl || 'Not checked'}<br>
          Connection: ${currentData.apiConnected ? '‚úÖ Connected' : '‚ùå Not connected'}<br>
          Build: ${currentData.buildNumber || 'Unknown'}
        </div>
      `;

      document.getElementById('dataGrid').style.display = 'grid';
    }

    async function checkAuth() {
      const loader = document.getElementById('loader');
      loader.style.display = 'block';

      try {
        log('üîê Checking Firebase Authentication...', 'header');
        
        const user = auth.currentUser;
        if (user) {
          log(`‚úÖ Signed in as: ${user.email}`, 'success');
          log(`   User ID: ${user.uid}`, 'info');
          log(`   Display Name: ${user.displayName || 'N/A'}`, 'info');
          currentData.user = user;
          
          // Get fresh token
          const token = await user.getIdToken(true);
          log(`   Token length: ${token.length} chars`, 'info');
          
        } else {
          log('‚ùå No user currently signed in', 'error');
          currentData.user = null;
        }

        updateDataGrid();

      } catch (error) {
        log(`‚ùå Auth check failed: ${error.message}`, 'error');
      } finally {
        loader.style.display = 'none';
      }
    }

    async function checkAPI() {
      const loader = document.getElementById('loader');
      loader.style.display = 'block';

      try {
        log('‚ö° Testing API Connection...', 'header');
        
        const apiUrl = 'https://boardlytasks.netlify.app/.netlify/functions/api-final';
        currentData.apiUrl = apiUrl;
        
        log(`Testing: ${apiUrl}/projects`, 'info');
        
        const user = auth.currentUser;
        if (!user) {
          throw new Error('Must be signed in to test API');
        }

        const token = await user.getIdToken();
        
        const response = await fetch(`${apiUrl}/projects`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
        
        if (response.ok) {
          const data = await response.json();
          log(`‚úÖ API connected successfully`, 'success');
          log(`   Response type: ${Array.isArray(data) ? 'Array' : typeof data}`, 'info');
          log(`   Data length: ${Array.isArray(data) ? data.length : 'N/A'}`, 'info');
          currentData.apiConnected = true;
        } else {
          const errorText = await response.text();
          log(`‚ùå API error: ${errorText}`, 'error');
          currentData.apiConnected = false;
        }

      } catch (error) {
        log(`‚ùå API test failed: ${error.message}`, 'error');
        currentData.apiConnected = false;
      } finally {
        loader.style.display = 'none';
        updateDataGrid();
      }
    }

    async function checkProjects() {
      const loader = document.getElementById('loader');
      loader.style.display = 'block';

      try {
        log('üìÅ Checking Projects...', 'header');
        
        const user = auth.currentUser;
        if (!user) {
          throw new Error('Must be signed in to check projects');
        }

        // Check via API first
        try {
          const token = await user.getIdToken();
          const response = await fetch('https://boardlytasks.netlify.app/.netlify/functions/api-final/projects', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const projects = await response.json();
            log(`‚úÖ API returned ${Array.isArray(projects) ? projects.length : 0} projects`, 'success');
            currentData.projects = Array.isArray(projects) ? projects : [];
            
            if (Array.isArray(projects) && projects.length > 0) {
              projects.forEach(p => {
                log(`   üìÅ ${p.name} (ID: ${p.id})`, 'info');
              });
            } else {
              log('   No projects found via API', 'warning');
            }
          } else {
            throw new Error(`API error: ${response.status}`);
          }
        } catch (apiError) {
          log(`‚ùå API check failed: ${apiError.message}`, 'error');
          
          // Fallback: Direct Firestore check
          log('üîÑ Trying direct Firestore check...', 'info');
          const snapshot = await db.collection('projects')
            .where('userId', '==', user.uid)
            .get();
          
          log(`‚úÖ Firestore returned ${snapshot.size} projects`, 'success');
          const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          currentData.projects = projects;
          
          projects.forEach(p => {
            log(`   üìÅ ${p.name} (Direct)`, 'info');
          });
        }

      } catch (error) {
        log(`‚ùå Project check failed: ${error.message}`, 'error');
      } finally {
        loader.style.display = 'none';
        updateDataGrid();
      }
    }

    async function checkTasks() {
      const loader = document.getElementById('loader');
      loader.style.display = 'block';

      try {
        log('üìã Checking Tasks...', 'header');
        
        const user = auth.currentUser;
        if (!user) {
          throw new Error('Must be signed in to check tasks');
        }

        // Check via API first
        try {
          const token = await user.getIdToken();
          const response = await fetch('https://boardlytasks.netlify.app/.netlify/functions/api-final/tasks/my-tasks', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const tasks = await response.json();
            log(`‚úÖ API returned ${Array.isArray(tasks) ? tasks.length : 0} tasks`, 'success');
            currentData.tasks = Array.isArray(tasks) ? tasks : [];
            
            if (Array.isArray(tasks) && tasks.length > 0) {
              tasks.slice(0, 5).forEach(t => {
                log(`   üìã ${t.title || 'Untitled'} (Project: ${t.project_name || 'None'})`, 'info');
              });
              if (tasks.length > 5) {
                log(`   ... and ${tasks.length - 5} more tasks`, 'info');
              }
            } else {
              log('   No tasks found via API', 'warning');
            }
          } else {
            throw new Error(`API error: ${response.status}`);
          }
        } catch (apiError) {
          log(`‚ùå API check failed: ${apiError.message}`, 'error');
          
          // Fallback: Direct Firestore check
          log('üîÑ Trying direct Firestore check...', 'info');
          const snapshot = await db.collection('tasks')
            .where('userId', '==', user.uid)
            .get();
          
          log(`‚úÖ Firestore returned ${snapshot.size} tasks`, 'success');
          const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          currentData.tasks = tasks;
          
          tasks.slice(0, 5).forEach(t => {
            log(`   üìã ${t.title || 'Untitled'} (Direct)`, 'info');
          });
        }

      } catch (error) {
        log(`‚ùå Task check failed: ${error.message}`, 'error');
      } finally {
        loader.style.display = 'none';
        updateDataGrid();
      }
    }

    async function forceSignIn() {
      try {
        log('üö™ Forcing sign-in with chris@chris.com...', 'header');
        
        await auth.signInWithEmailAndPassword('chris@chris.com', 'Test123');
        log('‚úÖ Signed in successfully!', 'success');
        
        // Auto-check everything
        await checkAuth();
        
      } catch (error) {
        log(`‚ùå Sign-in failed: ${error.message}`, 'error');
        log('Please check if the account exists and password is correct', 'warning');
        
        // Try to create the account if it doesn't exist
        try {
          log('üÜï Attempting to create account...', 'info');
          await auth.createUserWithEmailAndPassword('chris@chris.com', 'Test123');
          log('‚úÖ Account created and signed in!', 'success');
          await checkAuth();
        } catch (createError) {
          log(`‚ùå Account creation failed: ${createError.message}`, 'error');
        }
      }
    }

    // Auto-check auth on load
    auth.onAuthStateChanged(user => {
      if (user) {
        log(`üîÑ Auth state changed: ${user.email}`, 'info');
        currentData.user = user;
        updateDataGrid();
      }
    });

    // Get build number
    fetch('/version.json')
      .then(r => r.json())
      .then(data => {
        currentData.buildNumber = `#${data.build}`;
        updateDataGrid();
      })
      .catch(() => {
        currentData.buildNumber = 'Unknown';
        updateDataGrid();
      });
  </script>
</body>
</html>